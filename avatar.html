<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Create Avatar — Theju AI</title>
  <style>
    body { margin:0; height:100vh; background:#0b0b0b; color:#fff; font-family:Arial; display:flex; flex-direction:column; }
    header { padding:14px; text-align:center; background:rgba(0,0,0,0.6); box-shadow:0 0 18px rgba(0,255,255,0.08); }
    #frame { flex:1; border:0; width:100%; height:100%; }
    #status { padding:10px; text-align:center; font-size:0.95rem; background:rgba(0,0,0,0.6); }
    #goBrain { display:none; padding:10px 20px; margin:15px auto; border:none; border-radius:10px;
      font-size:1rem; cursor:pointer; background:linear-gradient(45deg, cyan, #00e0e0); color:#0f2027; }
  </style>
</head>
<body>
  <header><strong>Create your avatar</strong> — when finished click export</header>
  <iframe id="frame" allow="camera *; microphone *; clipboard-write"></iframe>
  <div id="status">Open editor and create your avatar. When you click Done/Export the avatar will be saved to your session.</div>
  <button id="goBrain">Step Into Your Digital Self</button>

<script>
  const params = new URLSearchParams(location.search);
  const subdomain = params.get('subdomain');
  const returnTo = params.get('return') || 'brain.html';

  const iframe = document.getElementById('frame');
  const status = document.getElementById('status');
  const goBrain = document.getElementById('goBrain');

  // Editor URL per subdomain (male vs female)
  const editorUrl = subdomain ? `https://${subdomain}.readyplayer.me/avatar?frameApi` : `https://readyplayer.me/avatar?frameApi`;
  iframe.src = editorUrl;

  window.addEventListener('message', (event) => {
    let json = null;
    try { json = JSON.parse(event.data); } catch(e) { return; }
    if (json.source !== 'readyplayerme') return;

    if (json.eventName === 'v1.frame.ready') {
      iframe.contentWindow.postMessage(JSON.stringify({
        target: 'readyplayerme',
        type: 'subscribe',
        eventName: 'v1.**'
      }), '*');
      status.innerText = 'Editor ready. Create your avatar and click Done.';
    }

    if (json.eventName === 'v1.avatar.exported') {
      const url = json.data && (json.data.url || json.data.avatarUrl || json.data.glb);
      if (url) {
        localStorage.setItem('theju_avatar_url', url);
        status.innerText = '✅ Avatar saved. Click below to continue.';
        goBrain.style.display = 'block';
        goBrain.onclick = () => window.location.href = returnTo;
      }
    }
  });
</script>
</body>
</html>
